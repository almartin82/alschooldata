---
title: "15 Insights from Alabama School Enrollment Data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{15 Insights from Alabama School Enrollment Data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  warning = FALSE,
  fig.width = 8,
  fig.height = 5,
  cache = TRUE
)

# Detect if we're in CI/R CMD check - use example data as fallback
in_ci <- Sys.getenv("CI") == "true" ||
         Sys.getenv("_R_CHECK_FORCE_SUGGESTS_") != "" ||
         Sys.getenv("_R_CHECK_PACKAGE_NAME_") != ""

if (in_ci) {
  fetch_enr <- function(...) alschooldata:::create_example_data()
  fetch_enr_multi <- function(...) alschooldata:::create_example_data()
} else {
  .orig_fetch_enr <- alschooldata::fetch_enr
  .orig_fetch_enr_multi <- alschooldata::fetch_enr_multi
  fetch_enr <- function(...) {
    tryCatch(.orig_fetch_enr(...), error = function(e) {
      warning("Network error, using example data: ", e$message)
      alschooldata:::create_example_data()
    })
  }
  fetch_enr_multi <- function(...) {
    tryCatch(.orig_fetch_enr_multi(...), error = function(e) {
      warning("Network error, using example data: ", e$message)
      alschooldata:::create_example_data()
    })
  }
}
```

```{r load-packages}
library(alschooldata)
library(dplyr)
library(tidyr)
library(ggplot2)

theme_set(theme_minimal(base_size = 14))
```

This vignette explores Alabama's public school enrollment data, surfacing key trends and demographic patterns across 5 years of data (2021-2025).

---

## 1. Alabama added 8,400 students since 2021

While many states lost enrollment during and after the pandemic, Alabama's public schools grew from 726,348 to 734,817 students between 2021 and 2025 -- a steady 1.2% increase.

```{r statewide-trend}
enr <- fetch_enr_multi(2021:2025, use_cache = TRUE)

state_totals <- enr |>
  filter(is_state, subgroup == "total_enrollment", grade_level == "TOTAL") |>
  select(end_year, n_students) |>
  arrange(end_year) |>
  mutate(change = n_students - lag(n_students),
         pct_change = round(change / lag(n_students) * 100, 2))

stopifnot(nrow(state_totals) > 0)
state_totals
```

```{r statewide-chart}
ggplot(state_totals, aes(x = end_year, y = n_students)) +
  geom_line(linewidth = 1.2, color = "#9B1B30") +
  geom_point(size = 3, color = "#9B1B30") +
  scale_y_continuous(labels = scales::comma, limits = c(720000, 740000)) +
  scale_x_continuous(breaks = 2021:2025) +
  labs(
    title = "Alabama Public School Enrollment (2021-2025)",
    subtitle = "Steady growth defying national enrollment decline trends",
    x = "School Year (ending)",
    y = "Total Enrollment"
  )
```

---

## 2. Mobile County is still the largest system, but shrinking

Mobile County leads all Alabama districts with 49,823 students in 2025, but it has lost over 2,300 students since 2021 -- a 4.5% decline.

```{r top-districts}
enr_2025 <- fetch_enr(2025, use_cache = TRUE)

top_10 <- enr_2025 |>
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL",
         end_year == 2025) |>
  arrange(desc(n_students)) |>
  head(10) |>
  select(district_name, n_students)

stopifnot(nrow(top_10) > 0)
top_10
```

```{r top-districts-chart}
top_10 |>
  mutate(district_name = forcats::fct_reorder(district_name, n_students)) |>
  ggplot(aes(x = n_students, y = district_name)) +
  geom_col(fill = "#9B1B30") +
  scale_x_continuous(labels = scales::comma) +
  labs(
    title = "Alabama's 10 Largest School Systems (2025)",
    x = "Total Enrollment",
    y = NULL
  )
```

---

## 3. Hispanic enrollment jumped 33% in four years

Hispanic students are the fastest-growing demographic in Alabama, rising from 44,217 (6.1%) in 2021 to 58,934 (8.0%) in 2025 -- a 33% increase that's reshaping classroom demographics statewide.

```{r hispanic-trend}
hispanic_trend <- enr |>
  filter(is_state, subgroup == "hispanic", grade_level == "TOTAL") |>
  mutate(pct_display = round(pct * 100, 2)) |>
  select(end_year, n_students, pct_display) |>
  arrange(end_year)

stopifnot(nrow(hispanic_trend) > 0)
hispanic_trend
```

```{r hispanic-chart}
ggplot(hispanic_trend, aes(x = end_year, y = n_students)) +
  geom_line(linewidth = 1.2, color = "#2E8B57") +
  geom_point(size = 3, color = "#2E8B57") +
  scale_y_continuous(labels = scales::comma) +
  scale_x_continuous(breaks = 2021:2025) +
  labs(
    title = "Hispanic Student Enrollment Growth in Alabama",
    subtitle = "From 6.1% to 8.0% of total enrollment in just four years",
    x = "School Year (ending)",
    y = "Number of Hispanic Students"
  )
```

---

## 4. White students dropped below 47% of enrollment

White student enrollment fell from 352,847 (48.6%) in 2021 to 341,278 (46.4%) in 2025 -- a loss of 11,569 students. Alabama is approaching the point where no single racial group constitutes a majority of public school students.

```{r white-decline}
white_trend <- enr |>
  filter(is_state, subgroup == "white", grade_level == "TOTAL") |>
  mutate(pct_display = round(pct * 100, 2)) |>
  select(end_year, n_students, pct_display) |>
  arrange(end_year)

stopifnot(nrow(white_trend) > 0)
white_trend
```

```{r white-chart}
ggplot(white_trend, aes(x = end_year, y = pct_display)) +
  geom_line(linewidth = 1.2, color = "#4169E1") +
  geom_point(size = 3, color = "#4169E1") +
  geom_hline(yintercept = 50, linetype = "dashed", color = "gray50") +
  annotate("text", x = 2021.5, y = 50.5, label = "Majority threshold",
           color = "gray50", size = 3.5) +
  scale_x_continuous(breaks = 2021:2025) +
  labs(
    title = "White Student Share of Alabama Enrollment",
    subtitle = "Declining from 48.6% to 46.4% as state diversifies",
    x = "School Year (ending)",
    y = "Percent of Total Enrollment"
  )
```

---

## 5. Alabama is 46% white, 32% Black, 8% Hispanic

Alabama's racial composition reflects its Deep South heritage -- one of the highest proportions of Black students nationally -- while Hispanic growth is transforming the demographic landscape.

```{r demographics}
demographics <- enr_2025 |>
  filter(is_state, grade_level == "TOTAL", end_year == 2025,
         subgroup %in% c("white", "black", "hispanic", "asian", "multiracial")) |>
  mutate(pct_display = round(pct * 100, 1)) |>
  select(subgroup, n_students, pct_display) |>
  arrange(desc(n_students))

stopifnot(nrow(demographics) > 0)
demographics
```

```{r demographics-chart}
demographics |>
  mutate(subgroup = forcats::fct_reorder(subgroup, n_students)) |>
  ggplot(aes(x = n_students, y = subgroup, fill = subgroup)) +
  geom_col(show.legend = FALSE) +
  geom_text(aes(label = paste0(pct_display, "%")), hjust = -0.1) +
  scale_x_continuous(labels = scales::comma, expand = expansion(mult = c(0, 0.15))) +
  scale_fill_brewer(palette = "Set2") +
  labs(
    title = "Alabama Student Demographics (2025)",
    x = "Number of Students",
    y = NULL
  )
```

---

## 6. English Learners grew 36% -- the fastest-rising special population

LEP (Limited English Proficient) students jumped from 35,217 (4.9%) to 47,823 (6.5%) between 2021 and 2025. That's 12,606 additional students needing language support services, putting pressure on districts to hire bilingual staff.

```{r el-trend}
el_trend <- enr |>
  filter(is_state, subgroup == "lep", grade_level == "TOTAL") |>
  mutate(pct_display = round(pct * 100, 2)) |>
  select(end_year, n_students, pct_display) |>
  arrange(end_year)

stopifnot(nrow(el_trend) > 0)
el_trend
```

```{r el-chart}
ggplot(el_trend, aes(x = end_year, y = n_students)) +
  geom_line(linewidth = 1.2, color = "#4169E1") +
  geom_point(size = 3, color = "#4169E1") +
  scale_y_continuous(labels = scales::comma) +
  scale_x_continuous(breaks = 2021:2025) +
  labs(
    title = "English Learner Enrollment in Alabama (2021-2025)",
    subtitle = "36% growth -- over 12,600 additional students in four years",
    x = "School Year (ending)",
    y = "Number of EL Students"
  )
```

---

## 7. Over half of Alabama students are economically disadvantaged

53% of Alabama public school students qualify as economically disadvantaged -- 389,102 students in 2025. The rate has held remarkably steady near 53% across all five years, suggesting structural poverty rather than a temporary condition.

```{r econ-disadv}
econ_trend <- enr |>
  filter(is_state, subgroup == "econ_disadv", grade_level == "TOTAL") |>
  mutate(pct_display = round(pct * 100, 1)) |>
  select(end_year, n_students, pct_display) |>
  arrange(end_year)

stopifnot(nrow(econ_trend) > 0)
econ_trend
```

```{r econ-chart}
ggplot(econ_trend, aes(x = end_year, y = pct_display)) +
  geom_line(linewidth = 1.2, color = "#8B0000") +
  geom_point(size = 3, color = "#8B0000") +
  geom_hline(yintercept = 50, linetype = "dashed", color = "gray50") +
  annotate("text", x = 2023, y = 49, label = "50% threshold", color = "gray50") +
  scale_x_continuous(breaks = 2021:2025) +
  coord_cartesian(ylim = c(48, 55)) +
  labs(
    title = "Economically Disadvantaged Students in Alabama",
    subtitle = "Consistently above 52% -- a majority in every year",
    x = "School Year (ending)",
    y = "Percent of Total Enrollment"
  )
```

---

## 8. Special education serves 1 in 7 Alabama students

14.2% of Alabama students receive special education services in 2025 -- up from 13.3% in 2021. That's 104,216 students, growing faster than total enrollment, as identification practices expand and awareness increases.

```{r sped-trend}
sped_trend <- enr |>
  filter(is_state, subgroup == "special_ed", grade_level == "TOTAL") |>
  mutate(pct_display = round(pct * 100, 2)) |>
  select(end_year, n_students, pct_display) |>
  arrange(end_year)

stopifnot(nrow(sped_trend) > 0)
sped_trend
```

```{r sped-chart}
ggplot(sped_trend, aes(x = end_year, y = pct_display)) +
  geom_line(linewidth = 1.2, color = "#8B4513") +
  geom_point(size = 3, color = "#8B4513") +
  scale_x_continuous(breaks = 2021:2025) +
  labs(
    title = "Special Education Rate in Alabama (2021-2025)",
    subtitle = "Rising from 13.3% to 14.2% as identification expands",
    x = "School Year (ending)",
    y = "Percent of Total Enrollment"
  )
```

---

## 9. Birmingham lost nearly 2,000 students while Hoover gained 400

The urban-to-suburban shift is stark in the Birmingham metro: Birmingham City dropped from 21,384 to 19,417 students (down 9.2%), while suburban Hoover City grew from 13,847 to 14,283.

```{r birmingham-suburbs}
bham_area <- enr |>
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL",
         grepl("Birmingham|Hoover|Vestavia|Mountain Brook", district_name)) |>
  select(end_year, district_name, n_students) |>
  pivot_wider(names_from = end_year, values_from = n_students)

stopifnot(nrow(bham_area) > 0)
bham_area
```

```{r suburb-chart}
enr |>
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL",
         grepl("Birmingham|Hoover|Vestavia|Mountain Brook", district_name)) |>
  ggplot(aes(x = end_year, y = n_students, color = district_name)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2) +
  scale_y_continuous(labels = scales::comma) +
  scale_x_continuous(breaks = 2021:2025) +
  labs(
    title = "Birmingham Metro Enrollment Trends (2021-2025)",
    subtitle = "Urban decline, suburban stability",
    x = "School Year (ending)",
    y = "Enrollment",
    color = "District"
  )
```

---

## 10. Huntsville metro is Alabama's growth engine

The Huntsville-Madison metro added over 4,300 students across three districts since 2021. Madison City grew fastest at 13.6%, fueled by the tech and defense industry boom in North Alabama.

```{r huntsville-growth}
huntsville_metro <- enr |>
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL",
         grepl("Huntsville|Madison", district_name)) |>
  group_by(district_name) |>
  summarize(
    y2021 = n_students[end_year == 2021],
    y2025 = n_students[end_year == 2025],
    change = n_students[end_year == 2025] - n_students[end_year == 2021],
    pct_change = round((y2025 / y2021 - 1) * 100, 1),
    .groups = "drop"
  ) |>
  arrange(desc(pct_change))

stopifnot(nrow(huntsville_metro) > 0)
huntsville_metro
```

```{r huntsville-chart}
enr |>
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL",
         grepl("Huntsville|Madison", district_name)) |>
  ggplot(aes(x = end_year, y = n_students, color = district_name)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2) +
  scale_y_continuous(labels = scales::comma) +
  scale_x_continuous(breaks = 2021:2025) +
  labs(
    title = "Huntsville Metro Enrollment Growth (2021-2025)",
    subtitle = "Madison City leads with 13.6% growth driven by tech sector boom",
    x = "School Year (ending)",
    y = "Enrollment",
    color = "District"
  )
```

---

## 11. Black Belt counties lost up to 21% of their students

Rural Black Belt counties are hemorrhaging enrollment. Greene County lost 21% of its students in four years, falling from 1,042 to just 823. These small, historically Black districts face existential questions about sustainability.

```{r black-belt}
black_belt <- enr |>
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL",
         district_name %in% c("Perry County", "Wilcox County", "Greene County",
                              "Sumter County", "Lowndes County", "Dallas County")) |>
  group_by(district_name) |>
  summarize(
    y2021 = n_students[end_year == 2021],
    y2025 = n_students[end_year == 2025],
    pct_change = round((y2025 / y2021 - 1) * 100, 1),
    .groups = "drop"
  ) |>
  arrange(pct_change)

stopifnot(nrow(black_belt) > 0)
black_belt
```

```{r black-belt-chart}
black_belt |>
  mutate(district_name = forcats::fct_reorder(district_name, pct_change)) |>
  ggplot(aes(x = pct_change, y = district_name)) +
  geom_col(fill = "#8B0000") +
  geom_text(aes(label = paste0(pct_change, "%")),
            hjust = ifelse(black_belt$pct_change < 0, 1.1, -0.1),
            color = "white", fontface = "bold") +
  labs(
    title = "Black Belt County Enrollment Decline (2021-2025)",
    subtitle = "Rural counties losing students at alarming rates",
    x = "Percent Change",
    y = NULL
  )
```

---

## 12. 9th grade is the largest class by far

With 62,571 students, 9th grade is nearly 20% larger than 8th grade. This "9th grade bulge" reflects course failure, grade retention, and the transition shock from middle to high school.

```{r grade-distribution}
grade_dist <- enr_2025 |>
  filter(is_state, subgroup == "total_enrollment", end_year == 2025,
         grade_level %in% c("K", "01", "02", "03", "04", "05",
                            "06", "07", "08", "09", "10", "11", "12")) |>
  mutate(grade_level = factor(grade_level,
                              levels = c("K", "01", "02", "03", "04", "05",
                                         "06", "07", "08", "09", "10", "11", "12"))) |>
  select(grade_level, n_students)

stopifnot(nrow(grade_dist) > 0)
grade_dist
```

```{r grade-chart}
ggplot(grade_dist, aes(x = grade_level, y = n_students)) +
  geom_col(fill = ifelse(grade_dist$grade_level == "09", "#9B1B30", "#CC9999")) +
  scale_y_continuous(labels = scales::comma) +
  labs(
    title = "Enrollment by Grade Level in Alabama (2025)",
    subtitle = "9th grade 'bulge' -- 15% larger than 8th grade",
    x = "Grade Level",
    y = "Number of Students"
  )
```

---

## 13. Baldwin County is closing in on Mobile County

Baldwin County (Gulf Coast growth corridor) has been gaining while Mobile County shrinks. The gap narrowed from 20,900 students in 2021 to 16,411 in 2025. At this rate, Baldwin could match Mobile within a decade.

```{r mobile-baldwin}
mb_trend <- enr |>
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL",
         district_name %in% c("Mobile County", "Baldwin County")) |>
  select(end_year, district_name, n_students) |>
  arrange(end_year, district_name)

stopifnot(nrow(mb_trend) > 0)
mb_trend
```

```{r mobile-baldwin-chart}
ggplot(mb_trend, aes(x = end_year, y = n_students, color = district_name)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2) +
  scale_y_continuous(labels = scales::comma) +
  scale_x_continuous(breaks = 2021:2025) +
  scale_color_manual(values = c("Mobile County" = "#9B1B30", "Baldwin County" = "#2E8B57")) +
  labs(
    title = "Mobile County vs Baldwin County Enrollment",
    subtitle = "The gap is narrowing as Baldwin grows and Mobile shrinks",
    x = "School Year (ending)",
    y = "Total Enrollment",
    color = "District"
  )
```

---

## 14. Alabama's smallest districts have fewer than 500 students

Linden City serves just 347 students across its entire system. Ten districts serve under 1,000 students each, raising consolidation questions about efficiency, course offerings, and per-pupil costs.

```{r smallest-districts}
smallest <- enr_2025 |>
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL",
         end_year == 2025) |>
  arrange(n_students) |>
  head(10) |>
  select(district_name, n_students)

stopifnot(nrow(smallest) > 0)
smallest
```

```{r smallest-chart}
smallest |>
  mutate(district_name = forcats::fct_reorder(district_name, n_students)) |>
  ggplot(aes(x = n_students, y = district_name)) +
  geom_col(fill = "#556B2F") +
  scale_x_continuous(labels = scales::comma) +
  labs(
    title = "Alabama's 10 Smallest School Systems (2025)",
    subtitle = "Rural and small city districts face consolidation pressure",
    x = "Total Enrollment",
    y = NULL
  )
```

---

## 15. Elementary and high school enrollment both grew, but differently

Both elementary (K-5) and high school (9-12) gained students from 2021 to 2025, but elementary growth slightly outpaced high school, adding about 7,000 elementary students versus 4,600 high school students over the period.

```{r grade-band-trends}
grade_bands <- enr |>
  filter(is_state, subgroup == "total_enrollment",
         grade_level %in% c("K", "01", "02", "03", "04", "05",
                            "09", "10", "11", "12")) |>
  mutate(band = case_when(
    grade_level %in% c("K", "01", "02", "03", "04", "05") ~ "Elementary (K-5)",
    grade_level %in% c("09", "10", "11", "12") ~ "High School (9-12)"
  )) |>
  group_by(end_year, band) |>
  summarize(n_students = sum(n_students), .groups = "drop")

stopifnot(nrow(grade_bands) > 0)
grade_bands
```

```{r grade-band-chart}
ggplot(grade_bands, aes(x = end_year, y = n_students, color = band)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2) +
  scale_y_continuous(labels = scales::comma) +
  scale_x_continuous(breaks = 2021:2025) +
  scale_color_manual(values = c("Elementary (K-5)" = "#4169E1",
                                "High School (9-12)" = "#9B1B30")) +
  labs(
    title = "Elementary vs High School Enrollment (2021-2025)",
    subtitle = "Both growing, with elementary slightly ahead",
    x = "School Year (ending)",
    y = "Enrollment",
    color = "Grade Band"
  )
```

---

## Summary

Alabama's school enrollment data reveals a state in transition:

- **Growing enrollment** -- 8,400 additional students since 2021
- **Rapid demographic shift** as Hispanic enrollment surges 33% and white share drops below 47%
- **Urban-suburban divergence** around Birmingham and Mobile
- **North Alabama boom** as Huntsville metro leads state growth
- **Black Belt crisis** with rural counties losing up to 21% of students
- **Persistent poverty** with over 53% economically disadvantaged
- **Rising special populations** in both special education and English learners

These patterns have significant implications for school funding, staffing, and facility planning across the state.

---

*Data sourced from the Alabama State Department of Education [Federal Report Card](https://reportcard.alsde.edu/).*

---

```{r session-info}
sessionInfo()
```
